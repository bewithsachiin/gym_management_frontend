generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPERADMIN
  ADMIN
  GENERALTRAINER
  PERSONALTRAINER
  MEMBER
  HOUSEKEEPING
  RECEPTIONIST
}

// Staff Role model for dynamic role management
model StaffRole {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  staff Staff[]
}

enum BranchStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

// User model for authentication and role management
model User {
  id        Int      @id @default(autoincrement())
  firstName String
  lastName  String
  email     String   @unique
  password  String // Hashed password
  role      Role     @default(MEMBER)
  branchId  Int?
  branch    Branch?  @relation(fields: [branchId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  adminBranches  Branch[] @relation("BranchAdmin")
  managedMembers Member[] @relation("StaffMembers")
  managedStaff   Staff[]  @relation("StaffManager")
  createdStaff   Staff[]  @relation("StaffCreator")
  scannedQRs     QRCheck[] @relation("QRCheckScanner")
}

// Branch model for gym branches
model Branch {
  id           Int          @id @default(autoincrement())
  name         String
  code         String       @unique
  address      String
  phone        String?
  email        String?
  status       BranchStatus @default(INACTIVE)
  hours        Json
  branch_image String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  adminId Int
  admin   User     @relation("BranchAdmin", fields: [adminId], references: [id])
  users   User[]
  staff   Staff[]
  members Member[]
  plans   MembershipPlan[]
  qrChecks QRCheck[]
  attendances Attendance[]
}

// Staff model for staff management
model Staff {
  id                      Int       @id @default(autoincrement())
  userId                  Int       @unique
  user                    User      @relation("StaffManager", fields: [userId], references: [id])
  branchId                Int
  branch                  Branch    @relation(fields: [branchId], references: [id])
  roleId                  Int
  role                    StaffRole @relation(fields: [roleId], references: [id])
  staff_id                String    @unique
  gender                  String?
  dob                     DateTime?
  phone                   String?
  profile_photo           String?
  status                  String    @default("Active")
  join_date               DateTime
  exit_date               DateTime?
  salary_type             String? // "Fixed" or "Hourly"
  hourly_rate             Float?
  fixed_salary            Float?
  commission_rate_percent Float     @default(0)
  login_enabled           Boolean   @default(false)
  username                String?
  password                String? // Hashed password for staff login
  createdById             Int // ID of the user who created this staff record
  createdBy               User      @relation("StaffCreator", fields: [createdById], references: [id])
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relations
  managedMembers Member[] @relation("StaffMembers")
  qrChecks       QRCheck[]
  attendances    Attendance[]
}

// Member model for gym members
model Member {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation("StaffMembers", fields: [userId], references: [id])
  branchId  Int
  branch    Branch   @relation(fields: [branchId], references: [id])
  staffId   Int?
  staff     Staff?   @relation("StaffMembers", fields: [staffId], references: [id])
  phone     String?
  status    String   @default("Active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions Subscription[]
  qrChecks      QRCheck[]
  attendances   Attendance[]
}

// Membership Plan model for gym membership plans
model MembershipPlan {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  durationDays Int
  priceCents   Int
  currency     String   @default("INR")
  features     Json     // Array of feature strings
  status       String   @default("Active")
  branchId     Int?
  branch       Branch?  @relation(fields: [branchId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  subscriptions Subscription[]
}

// Subscription model for member subscriptions
model Subscription {
  id        Int             @id @default(autoincrement())
  memberId  Int
  member    Member          @relation(fields: [memberId], references: [id])
  planId    Int
  plan      MembershipPlan  @relation(fields: [planId], references: [id])
  startDate DateTime
  endDate   DateTime
  status    String          @default("Active") // Active, Expired, Cancelled
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

// QRCheck model for quick log of scanned QR entries
model QRCheck {
  id        Int      @id @default(autoincrement())
  memberId  Int?
  staffId   Int?
  branchId  Int
  nonce     String   @unique
  issuedAt  DateTime
  expiresAt DateTime
  scannedAt DateTime?
  action    String   // 'checkin' or 'checkout'
  status    String   @default("valid") // valid, expired, invalid, used
  scannedBy Int?     // userId of who scanned
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  member    Member?  @relation(fields: [memberId], references: [id])
  staff     Staff?   @relation(fields: [staffId], references: [id])
  branch    Branch   @relation(fields: [branchId], references: [id])
  scanner   User?    @relation("QRCheckScanner", fields: [scannedBy], references: [id])
}

// Attendance model for official attendance records
model Attendance {
  id          Int      @id @default(autoincrement())
  memberId    Int?
  staffId     Int?
  branchId    Int
  date        DateTime // date of attendance
  checkInTime DateTime?
  checkOutTime DateTime?
  totalHours  Float?
  status      String   @default("active") // active, completed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  member      Member?  @relation(fields: [memberId], references: [id])
  staff       Staff?   @relation(fields: [staffId], references: [id])
  branch      Branch   @relation(fields: [branchId], references: [id])
}
